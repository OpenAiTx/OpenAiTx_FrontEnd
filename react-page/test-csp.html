<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>CSP æ¸¬è©¦é é¢</title>

        <!-- Apply the same CSP configuration as production environment -->
        <!-- Note: frame-ancestors and X-Frame-Options cannot be used in meta tags -->
        <!-- These security headers can only be set in HTTP response headers, GitHub Pages doesn't support custom response headers -->
        <meta
            http-equiv="Content-Security-Policy"
            content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://openaitx.github.io https://*.github.io;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://openaitx.github.io;
        font-src 'self' https://fonts.gstatic.com https://openaitx.github.io;
        img-src 'self' data: https: https://img.shields.io https://raw.githubusercontent.com https://openaitx.github.io https://*.github.io https://github.com;
        connect-src 'self' https://api.github.com https://raw.githubusercontent.com https://openaitx.com https://img.shields.io https://openaitx.github.io https://*.github.io;
        media-src 'self' data: https:;
        object-src 'none';
        base-uri 'self';
        form-action 'self' https://openaitx.com;
        upgrade-insecure-requests;
    " />

        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f5f5;
            }
            .test-section {
                background: white;
                padding: 20px;
                margin: 20px 0;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .success {
                color: #22c55e;
            }
            .error {
                color: #ef4444;
            }
            .warning {
                color: #f59e0b;
            }
            .test-result {
                margin: 10px 0;
                padding: 10px;
                border-radius: 4px;
                font-weight: bold;
            }
            .test-result.success {
                background-color: #dcfce7;
            }
            .test-result.error {
                background-color: #fef2f2;
            }
            .test-result.warning {
                background-color: #fef3c7;
            }
            button {
                background-color: #3b82f6;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                margin: 5px;
            }
            button:hover {
                background-color: #2563eb;
            }
            #results {
                margin-top: 20px;
            }
        </style>
    </head>
    <body>
        <h1>ğŸ”’ CSP é…ç½®æ¸¬è©¦é é¢</h1>

        <div class="test-section">
            <h2>ğŸ“‹ æ¸¬è©¦èªªæ˜</h2>
            <p>æ­¤é é¢ç”¨æ–¼æ¸¬è©¦ Content Security Policy é…ç½®æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
            <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é€²è¡Œå„ç¨®æ¸¬è©¦ï¼Œçµæœæœƒé¡¯ç¤ºåœ¨ä¸‹æ–¹ã€‚</p>
            <p><strong>æ³¨æ„ï¼š</strong>æŸäº›æ¸¬è©¦é æœŸæœƒå¤±æ•—ï¼Œé€™è¡¨ç¤º CSP æ­£åœ¨æ­£å¸¸å·¥ä½œã€‚</p>
        </div>

        <div class="test-section">
            <h2>ğŸ§ª CSP æ¸¬è©¦é …ç›®</h2>

            <button onclick="testAllowedScript()">æ¸¬è©¦å…è¨±çš„è…³æœ¬</button>
            <button onclick="testBlockedScript()">æ¸¬è©¦è¢«é˜»æ­¢çš„è…³æœ¬</button>
            <button onclick="testAllowedStyle()">æ¸¬è©¦å…è¨±çš„æ¨£å¼</button>
            <button onclick="testAllowedImage()">æ¸¬è©¦å…è¨±çš„åœ–ç‰‡</button>
            <button onclick="testBlockedImage()">æ¸¬è©¦è¢«é˜»æ­¢çš„åœ–ç‰‡</button>
            <button onclick="testAllowedAPI()">æ¸¬è©¦å…è¨±çš„ API</button>
            <button onclick="testBlockedAPI()">æ¸¬è©¦è¢«é˜»æ­¢çš„ API</button>
            <button onclick="runAllTests()">é‹è¡Œæ‰€æœ‰æ¸¬è©¦</button>

            <div id="results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š ç•¶å‰ CSP é…ç½®</h2>
            <div id="csp-policy"></div>
        </div>

        <script>
            const results = document.getElementById("results");
            const cspPolicy = document.getElementById("csp-policy");

            // é¡¯ç¤ºç•¶å‰ CSP é…ç½®
            function showCSPPolicy() {
                const metaCSP = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
                if (metaCSP) {
                    const policy = metaCSP.getAttribute("content");
                    cspPolicy.innerHTML = `<pre style="background:#f8f9fa;padding:10px;border-radius:4px;overflow-x:auto;">${policy}</pre>`;
                } else {
                    cspPolicy.innerHTML = '<p class="error">æœªæ‰¾åˆ° CSP é…ç½®</p>';
                }
            }

            // æ·»åŠ æ¸¬è©¦çµæœ
            function addResult(test, status, message) {
                const result = document.createElement("div");
                result.className = `test-result ${status}`;
                result.innerHTML = `<strong>${test}:</strong> ${message}`;
                results.appendChild(result);
            }

            // æ¸…é™¤çµæœ
            function clearResults() {
                results.innerHTML = "";
            }

            // æ¸¬è©¦å…è¨±çš„è…³æœ¬ï¼ˆå…§è¯è…³æœ¬ï¼‰
            function testAllowedScript() {
                try {
                    eval('console.log("å…§è¯è…³æœ¬æ¸¬è©¦")');
                    addResult("å…§è¯è…³æœ¬", "success", "âœ… å…è¨±åŸ·è¡Œï¼ˆé æœŸçµæœï¼‰");
                } catch (e) {
                    addResult("å…§è¯è…³æœ¬", "error", "âŒ è¢«é˜»æ­¢ï¼š" + e.message);
                }
            }

            // æ¸¬è©¦è¢«é˜»æ­¢çš„è…³æœ¬ï¼ˆå¤–éƒ¨æƒ¡æ„è…³æœ¬ï¼‰
            function testBlockedScript() {
                const script = document.createElement("script");
                script.src = "https://evil.example.com/malicious.js";
                script.onload = () => {
                    addResult("å¤–éƒ¨æƒ¡æ„è…³æœ¬", "error", "âŒ æ„å¤–å…è¨±è¼‰å…¥");
                };
                script.onerror = () => {
                    addResult("å¤–éƒ¨æƒ¡æ„è…³æœ¬", "success", "âœ… æˆåŠŸé˜»æ­¢ï¼ˆé æœŸçµæœï¼‰");
                };

                // ç›£è½ CSP é•è¦
                const violationHandler = (e) => {
                    if (e.blockedURI && e.blockedURI.includes("evil.example.com")) {
                        addResult("å¤–éƒ¨æƒ¡æ„è…³æœ¬", "success", "âœ… CSP æˆåŠŸé˜»æ­¢ï¼ˆé æœŸçµæœï¼‰");
                        document.removeEventListener("securitypolicyviolation", violationHandler);
                    }
                };
                document.addEventListener("securitypolicyviolation", violationHandler);

                document.head.appendChild(script);

                // 2ç§’å¾Œç§»é™¤ç›£è½å™¨
                setTimeout(() => {
                    document.removeEventListener("securitypolicyviolation", violationHandler);
                }, 2000);
            }

            // æ¸¬è©¦å…è¨±çš„æ¨£å¼
            function testAllowedStyle() {
                try {
                    const style = document.createElement("style");
                    style.textContent = ".test-style { color: green; }";
                    document.head.appendChild(style);
                    addResult("å…§è¯æ¨£å¼", "success", "âœ… å…è¨±è¼‰å…¥ï¼ˆé æœŸçµæœï¼‰");
                } catch (e) {
                    addResult("å…§è¯æ¨£å¼", "error", "âŒ è¢«é˜»æ­¢ï¼š" + e.message);
                }
            }

            // æ¸¬è©¦å…è¨±çš„åœ–ç‰‡
            function testAllowedImage() {
                const img = document.createElement("img");
                img.src = "https://img.shields.io/badge/test-badge-blue";
                img.style.display = "none";
                img.onload = () => {
                    addResult("Shields.io åœ–ç‰‡", "success", "âœ… å…è¨±è¼‰å…¥ï¼ˆé æœŸçµæœï¼‰");
                };
                img.onerror = () => {
                    addResult("Shields.io åœ–ç‰‡", "error", "âŒ è¼‰å…¥å¤±æ•—");
                };
                document.body.appendChild(img);
            }

            // æ¸¬è©¦è¢«é˜»æ­¢çš„åœ–ç‰‡
            function testBlockedImage() {
                const img = document.createElement("img");
                img.src = "https://evil.example.com/malicious.png";
                img.style.display = "none";
                img.onload = () => {
                    addResult("å¤–éƒ¨æƒ¡æ„åœ–ç‰‡", "error", "âŒ æ„å¤–å…è¨±è¼‰å…¥");
                };
                img.onerror = () => {
                    addResult("å¤–éƒ¨æƒ¡æ„åœ–ç‰‡", "success", "âœ… æˆåŠŸé˜»æ­¢ï¼ˆé æœŸçµæœï¼‰");
                };
                document.body.appendChild(img);
            }

            // æ¸¬è©¦å…è¨±çš„ API
            function testAllowedAPI() {
                fetch("https://api.github.com/repos/OpenAiTx/OpenAiTx")
                    .then((response) => {
                        if (response.ok) {
                            addResult("GitHub API", "success", "âœ… å…è¨±é€£æ¥ï¼ˆé æœŸçµæœï¼‰");
                        } else {
                            addResult("GitHub API", "warning", "âš ï¸ é€£æ¥ä½†è¿”å›éŒ¯èª¤");
                        }
                    })
                    .catch((error) => {
                        addResult("GitHub API", "error", "âŒ é€£æ¥å¤±æ•—ï¼š" + error.message);
                    });
            }

            // æ¸¬è©¦è¢«é˜»æ­¢çš„ API
            function testBlockedAPI() {
                fetch("https://evil.example.com/api/malicious")
                    .then((response) => {
                        addResult("å¤–éƒ¨æƒ¡æ„ API", "error", "âŒ æ„å¤–å…è¨±é€£æ¥");
                    })
                    .catch((error) => {
                        if (error.message.includes("Failed to fetch")) {
                            addResult("å¤–éƒ¨æƒ¡æ„ API", "success", "âœ… æˆåŠŸé˜»æ­¢ï¼ˆé æœŸçµæœï¼‰");
                        } else {
                            addResult("å¤–éƒ¨æƒ¡æ„ API", "warning", "âš ï¸ å…¶ä»–éŒ¯èª¤ï¼š" + error.message);
                        }
                    });
            }

            // é‹è¡Œæ‰€æœ‰æ¸¬è©¦
            function runAllTests() {
                clearResults();
                addResult("æ¸¬è©¦é–‹å§‹", "warning", "ğŸš€ é–‹å§‹é‹è¡Œæ‰€æœ‰ CSP æ¸¬è©¦...");

                setTimeout(() => testAllowedScript(), 100);
                setTimeout(() => testBlockedScript(), 200);
                setTimeout(() => testAllowedStyle(), 300);
                setTimeout(() => testAllowedImage(), 400);
                setTimeout(() => testBlockedImage(), 500);
                setTimeout(() => testAllowedAPI(), 600);
                setTimeout(() => testBlockedAPI(), 700);

                setTimeout(() => {
                    addResult("æ¸¬è©¦å®Œæˆ", "success", "âœ… æ‰€æœ‰æ¸¬è©¦å·²å®Œæˆ");
                }, 3000);
            }

            // ç›£è½ CSP é•è¦äº‹ä»¶
            document.addEventListener("securitypolicyviolation", (e) => {
                console.group("ğŸš¨ CSP é•è¦æª¢æ¸¬");
                console.log("è¢«é˜»æ­¢çš„ URI:", e.blockedURI);
                console.log("é•è¦æŒ‡ä»¤:", e.violatedDirective);
                console.log("åŸå§‹æ”¿ç­–:", e.originalPolicy);
                console.groupEnd();
            });

            // é é¢è¼‰å…¥æ™‚é¡¯ç¤º CSP é…ç½®
            window.addEventListener("load", showCSPPolicy);
        </script>
    </body>
</html>
